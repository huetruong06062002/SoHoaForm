name: Deploy to VPS

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Key_SoHoa_Form

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Kiá»ƒm tra vÃ  khá»Ÿi Ä‘á»™ng Docker
            echo "ğŸ³ Checking Docker status..."
            sudo systemctl start docker || echo "Docker already running"

            # Navigate to project directory
            cd /home/${{ secrets.VPS_USERNAME }}/sohoaform || {
              echo "âŒ Project directory not found. Cloning repository..."
              cd /home/${{ secrets.VPS_USERNAME }}
              git clone https://github.com/huetruong06062002/SoHoaForm.git sohoaform
              cd sohoaform
            }

            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ›‘ Stopping existing containers..."
            sudo docker-compose down --remove-orphans || echo "No containers to stop"

            echo "ğŸ§¹ Cleaning up old resources..."
            sudo docker system prune -f
            sudo docker volume prune -f || echo "No volumes to clean"

            echo "ğŸ—ï¸ Building and starting containers..."
            sudo docker-compose up -d --build --force-recreate

            echo "â³ Waiting for services to start..."
            sleep 60

            echo "ğŸ” Checking container status..."
            sudo docker-compose ps

            echo "ğŸ“‹ Checking logs..."
            sudo docker-compose logs --tail=50

            echo "ğŸŒ Testing API connectivity..."
            curl -f http://localhost:5000/health || curl -f http://localhost:5000 || echo "âš ï¸ API health check failed"

            echo "âœ… Deployment completed successfully!"
